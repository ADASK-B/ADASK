<!DOCTYPE html>
<html>
<head>
  <style>
    body { 
      margin: 0;
      font-family: Arial, sans-serif;
      cursor: default;
      overflow: hidden;
    }
    
    .container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    .controls {
      position: absolute;
      left: 20px;
      top: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 8px;
      color: white;
      z-index: 100;
    }

    .virtual-joystick {
      position: absolute;
      left: 0;
      top: 0;
      width: 50%;
      height: 100%;
      z-index: 100;
    }

    .camera-control {
      position: absolute;
      right: 0;
      top: 0;
      width: 50%;
      height: 100%;
      z-index: 100;
    }

    .action-buttons {
      position: absolute;
      right: 20px;
      bottom: 20px;
      z-index: 100;
    }

    .jump-button {
      background: rgba(255, 255, 255, 0.3);
      border: 2px solid white;
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .game-canvas {
      width: 100%;
      height: 100%;
    }

    .joystick-base {
      position: absolute;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: none;
    }

    .joystick-stick {
      position: absolute;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls">
      <h3>Steuerung:</h3>
      <p>Linke Seite: Bewegungssteuerung</p>
      <p>Rechte Seite: Kamerasteuerung</p>
      <p>Sprung-Button: Springen</p>
    </div>
    <div class="virtual-joystick">
      <div class="joystick-base">
        <div class="joystick-stick"></div>
      </div>
    </div>
    <div class="camera-control"></div>
    <div class="action-buttons">
      <button class="jump-button">JUMP</button>
    </div>
    <canvas class="game-canvas"></canvas>
  </div>

  <script type="module">
    import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';

    let camera, scene, renderer;
    let player;
    let platforms = [];
    let playerBoundingBox;
    let velocity = new THREE.Vector3();
    let canJump = false;
    let moveDirection = new THREE.Vector3();
    
    // Joystick Variablen
    let joystickBase;
    let joystickStick;
    let isJoystickActive = false;
    let joystickStartPos = new THREE.Vector2();
    let joystickCurrentPos = new THREE.Vector2();
    
    // Kamera Variablen
    let cameraRotation = 0;
    let isCameraMoving = false;
    let lastCameraX = 0;
    
    const MOVEMENT_SPEED = 15.0;
    const GRAVITY = 250.0;
    const JUMP_FORCE = 100.0;
    const COLLISION_THRESHOLD = 0.001;

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87CEEB);
      scene.fog = new THREE.Fog(0x87CEEB, 0, 750);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
      camera.position.set(0, 15, 20);

      const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);

      createPlatforms();
      createPlayer();

      renderer = new THREE.WebGLRenderer({
        canvas: document.querySelector('.game-canvas'),
        antialias: true
      });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;

      setupControls();
      window.addEventListener('resize', onWindowResize, false);
    }

    function createPlayer() {
      // Erstelle eine Kugel statt eines Würfels
      const geometry = new THREE.SphereGeometry(1, 32, 32);
      const material = new THREE.MeshPhongMaterial({ color: 0xFF0000 });
      player = new THREE.Mesh(geometry, material);
      player.position.set(0, 2, 0);
      player.castShadow = true;
      
      // Text "ADASK" auf der Kugel
      const textGeometry = new THREE.TextGeometry('ADASK', {
        size: 0.5,
        height: 0.1,
      });
      const textMaterial = new THREE.MeshPhongMaterial({ color: 0xFFFFFF });
      const text = new THREE.Mesh(textGeometry, textMaterial);
      text.position.set(-1, 0, 1);
      player.add(text);
      
      scene.add(player);
      
      // Angepasste Bounding Box für die Kugel
      playerBoundingBox = new THREE.Box3(
        new THREE.Vector3(-1, -1, -1),
        new THREE.Vector3(1, 1, 1)
      );
    }

    function setupControls() {
      joystickBase = document.querySelector('.joystick-base');
      joystickStick = document.querySelector('.joystick-stick');
      
      // Joystick Events
      const virtualJoystick = document.querySelector('.virtual-joystick');
      virtualJoystick.addEventListener('mousedown', startJoystick);
      document.addEventListener('mousemove', moveJoystick);
      document.addEventListener('mouseup', endJoystick);
      
      // Kamera Events
      const cameraControl = document.querySelector('.camera-control');
      cameraControl.addEventListener('mousedown', startCameraMove);
      cameraControl.addEventListener('mousemove', moveCameraView);
      cameraControl.addEventListener('mouseup', endCameraMove);
      
      // Sprung-Button
      const jumpButton = document.querySelector('.jump-button');
      jumpButton.addEventListener('click', () => {
        if (canJump) {
          velocity.y += JUMP_FORCE;
          canJump = false;
        }
      });
    }

    function startJoystick(event) {
      isJoystickActive = true;
      joystickBase.style.display = 'block';
      joystickBase.style.left = `${event.clientX - 50}px`;
      joystickBase.style.top = `${event.clientY - 50}px`;
      joystickStartPos.set(event.clientX, event.clientY);
      joystickCurrentPos.copy(joystickStartPos);
    }

    function moveJoystick(event) {
      if (!isJoystickActive) return;
      
      joystickCurrentPos.set(event.clientX, event.clientY);
      const deltaX = joystickCurrentPos.x - joystickStartPos.x;
      const deltaY = joystickCurrentPos.y - joystickStartPos.y;
      
      const distance = Math.min(50, Math.sqrt(deltaX * deltaX + deltaY * deltaY));
      const angle = Math.atan2(deltaY, deltaX);
      
      const stickX = Math.cos(angle) * distance;
      const stickY = Math.sin(angle) * distance;
      
      joystickStick.style.transform = `translate(${stickX}px, ${stickY}px)`;
      
      // Bewegungsrichtung basierend auf Joystick
      moveDirection.x = deltaX / 50;
      moveDirection.z = deltaY / 50;
    }

    function endJoystick() {
      isJoystickActive = false;
      joystickBase.style.display = 'none';
      joystickStick.style.transform = 'translate(0px, 0px)';
      moveDirection.set(0, 0, 0);
    }

    function startCameraMove(event) {
      isCameraMoving = true;
      lastCameraX = event.clientX;
    }

    function moveCameraView(event) {
      if (!isCameraMoving) return;
      
      const deltaX = event.clientX - lastCameraX;
      cameraRotation += deltaX * 0.01;
      lastCameraX = event.clientX;
    }

    function endCameraMove() {
      isCameraMoving = false;
    }

    function animate() {
      requestAnimationFrame(animate);
      
      const delta = 0.016; // ca. 60 FPS
      
      velocity.x = moveDirection.x * MOVEMENT_SPEED;
      velocity.z = moveDirection.z * MOVEMENT_SPEED;
      
      if (!checkPlatformCollisions()) {
        velocity.y -= GRAVITY * delta;
      }
      
      // Bewegung anwenden
      player.position.x += velocity.x * delta;
      player.position.z += velocity.z * delta;
      player.position.y += velocity.y * delta;
      
      // Kamera folgt dem Spieler
      const cameraDistance = 20;
      camera.position.x = player.position.x + Math.sin(cameraRotation) * cameraDistance;
      camera.position.z = player.position.z + Math.cos(cameraRotation) * cameraDistance;
      camera.position.y = player.position.y + 15;
      camera.lookAt(player.position);
      
      // Reset Position wenn zu tief gefallen
      if (player.position.y < -50) {
        player.position.set(0, 10, 0);
        velocity.set(0, 0, 0);
      }
      
      renderer.render(scene, camera);
    }

    function createPlatforms() {
      createPlatform(0, 0, 0, 30, 2, 30, 0x8B4513);
      createPlatform(25, 5, 0, 15, 2, 15, 0x228B22);
      createPlatform(50, 10, -10, 15, 2, 15, 0x4682B4);
      createPlatform(75, 15, 0, 15, 2, 15, 0xCD853F);
      createPlatform(100, 20, 10, 15, 2, 15, 0x8B008B);
      createPlatform(125, 25, 0, 15, 2, 15, 0xFFD700);
      createPlatform(125, 30, -20, 15, 2, 15, 0x00CED1);
      createPlatform(125, 35, -40, 15, 2, 15, 0xFF6347);
    }

    function createPlatform(x, y, z, width, height, depth, color) {
      const geometry = new THREE.BoxGeometry(width, height, depth);
      const material = new THREE.MeshPhongMaterial({ color: color });
      const platform = new THREE.Mesh(geometry, material);
      platform.position.set(x, y, z);
      platform.receiveShadow = true;
      platform.castShadow = true;
      
      const boundingBox = new THREE.Box3().setFromObject(platform);
      platform.userData.boundingBox = boundingBox;
      
      platforms.push(platform);
      scene.add(platform);
    }

    function checkPlatformCollisions() {
      playerBoundingBox.setFromObject(player);
      
      let onPlatform = false;
      
      platforms.forEach(platform => {
        if (playerBoundingBox.intersectsBox(platform.userData.boundingBox)) {
          const platformY = platform.position.y + (platform.geometry.parameters.height / 2);
          
          if (player.position.y >= platformY - COLLISION_THRESHOLD && velocity.y <= 0) {
            player.position.y = platformY + 1;
            velocity.y = 0;
            canJump = true;
            onPlatform = true;
          }
        }
      });

      return onPlatform;
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
  </script>
</body>
</html>